name: CI
on: [push]

jobs:
  docs:
    name: JSDocs
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v1
      with:
        node-version: '12.x'
    - run: npm install jsdoc
    - run: ./node_modules/.bin/jsdoc index.js
    - uses: actions/upload-artifact@v1
      with:
        name: jsdoc
        path: out
    # - name: WIP push to new GitHub pages
    #   run: |
    #     mv .git out/.git
    #     cd out
    #     git checkout -B gh-pages
    #     git add *
    #     git config user.name ${{ github.actor }}
    #     git config user.email bot@github.com
    #     git commit -m 'Created docs from ${{ github.sha }}'
    #     git push --force origin gh-pages:gh-pages


  test:
    name: ${{ matrix.os }} Py${{ matrix.python }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
        - ubuntu-latest
        # - macOS-latest
        # - windows-latest
        python:
        - 2.7
        # - 3.7
      fail-fast: true

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v1
        with:
          python-version: "${{ matrix.python }}"

      - uses: ./

      - run: rez --version
      - run: rez config local_packages_path
      - run: rez config release_packages_path
      - run: rez config packages_path
      - run: rez view os
      - run: rez view python

  inputs:
    name: ${{ matrix.ref }}@${{ matrix.source }}:${{ matrix.makePackagesPaths }} ${{ matrix.binds }} 
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 10
      matrix:
        source:
        # - nerdvegas/rez
        - mottosso/bleeding-rez
        ref:
        - master
        # - 2.33.0
        binds:
        # - ''
        - 'os, python'
        # - 'setuptools, pip'
        makePackagesPaths:
        - true
        # - false

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v1
        with:
          python-version: 2.7

      - uses: ./
        with:
          source: ${{ matrix.source }}
          ref: ${{ matrix.ref }}
          binds: ${{ matrix.binds }}
          makePackagesPaths: ${{ matrix.makePackagesPaths }}

      - run: rez status